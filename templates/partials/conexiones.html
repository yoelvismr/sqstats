{# Macro para formatear bandwidth #}
{% macro format_bandwidth(bw_value) %}
  {% if bw_value is defined %}
    {% set bw = bw_value|float %}
    {% if bw >= 1000000 %}
      {{ (bw / 1000000)|round(2) }} Gbps
    {% elif bw >= 1000 %}
      {{ (bw / 1000)|round(2) }} Mbps
    {% else %}
      {{ bw|round(2) }} Kbps
    {% endif %}
  {% else %}0 kbps{% endif %}
{% endmacro %}

{% set valid_users = {} %} 
{% for user, user_data in grouped_connections.items() %}
  {% if user and user != "-" and user != "Anónimo" %} 
    {% set _ = valid_users.update({user: user_data}) %} 
  {% endif %} 
{% endfor %}

{# Tarjetas de estadísticas - Mejorado para responsive #}
<div class="flex justify-center mb-6">
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 w-full">
    {# Tarjeta Servidor Squid #}
    <div class="bg-white p-3 sm:p-4 rounded-lg shadow flex items-center transition-all duration-300 ease-in-out hover:shadow-lg">
      <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-indigo-100 flex items-center justify-center mr-3 flex-shrink-0">
        <i class="fas fa-server text-indigo-500 text-lg sm:text-xl"></i>
      </div>
      <div class="min-w-0 flex-1">
        <p class="text-gray-500 text-xs sm:text-sm truncate">Servidor Squid:</p>
        <p class="text-lg sm:text-xl font-bold truncate" title="{{ squid_version }}">{{ squid_version }}</p>
      </div>
    </div>

    {# Tarjeta Bandwidth Total #}
    <div class="bg-white p-3 sm:p-4 rounded-lg shadow flex items-center transition-all duration-300 ease-in-out hover:shadow-lg">
      <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-teal-100 flex items-center justify-center mr-3 flex-shrink-0">
        <i class="fas fa-tachometer-alt text-teal-500 text-lg sm:text-xl"></i>
      </div>
      <div class="min-w-0 flex-1">
        <p class="text-gray-500 text-xs sm:text-sm">Total Bandwidth</p>
        <p class="text-lg sm:text-xl font-bold">
          {% set total_bw = namespace(value=0) %}
          {% for user_data in valid_users.values() %}
            {% for connection in user_data.connections %}
              {% if connection.bandwidth_kbps is defined %}
                {% set total_bw.value = total_bw.value + (connection.bandwidth_kbps|float) %}
              {% endif %}
            {% endfor %}
          {% endfor %}
          {{ format_bandwidth(total_bw.value) }}
        </p>
      </div>
    </div>

    {# Tarjeta Usuarios Activos #}
    <div class="bg-white p-3 sm:p-4 rounded-lg shadow flex items-center transition-all duration-300 ease-in-out hover:shadow-lg">
      <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-blue-100 flex items-center justify-center mr-3 flex-shrink-0">
        <i class="fas fa-users text-blue-500 text-lg sm:text-xl"></i>
      </div>
      <div>
        <p class="text-gray-500 text-xs sm:text-sm">Usuarios Activos</p>
        <p class="text-lg sm:text-xl font-bold">{{ valid_users|length }}</p>
      </div>
    </div>

    {# Tarjeta Conexiones Totales #}
    <div class="bg-white p-3 sm:p-4 rounded-lg shadow flex items-center transition-all duration-300 ease-in-out hover:shadow-lg">
      <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-green-100 flex items-center justify-center mr-3 flex-shrink-0">
        <i class="fas fa-exchange-alt text-green-500 text-lg sm:text-xl"></i>
      </div>
      <div>
        <p class="text-gray-500 text-xs sm:text-sm">Conexiones Totales</p>
        <p class="text-lg sm:text-xl font-bold">
          {% set total = namespace(value=0) %} 
          {% for user_data in valid_users.values() %} 
            {% set total.value = total.value + user_data.connections|length %} 
          {% endfor %} 
          {{ total.value }}
        </p>
      </div>
    </div>

    {# Tarjetas adicionales responsivas #}
    {% if squid_info_stats and squid_info_stats.elapsed_hours %}
    <div class="bg-white p-3 sm:p-4 rounded-lg shadow flex items-center transition-all duration-300 ease-in-out hover:shadow-lg">
      <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-purple-100 flex items-center justify-center mr-3 flex-shrink-0">
        <i class="fas fa-clock text-purple-500 text-lg sm:text-xl"></i>
      </div>
      <div>
        <p class="text-gray-500 text-xs sm:text-sm">Tiempo Activo</p>
        <p class="text-lg sm:text-xl font-bold">{{ squid_info_stats.elapsed_hours }}h</p>
      </div>
    </div>
    {% endif %}

    {% if squid_info_stats and squid_info_stats.requests_received %}
    <div class="bg-white p-3 sm:p-4 rounded-lg shadow flex items-center transition-all duration-300 ease-in-out hover:shadow-lg">
      <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-red-100 flex items-center justify-center mr-3 flex-shrink-0">
        <i class="fas fa-globe text-red-500 text-lg sm:text-xl"></i>
      </div>
      <div>
        <p class="text-gray-500 text-xs sm:text-sm">Total Peticiones HTTP</p>
        <p class="text-lg sm:text-xl font-bold">{{ squid_info_stats.requests_received | int }}</p>
      </div>
    </div>
    {% endif %}

    {% if squid_info_stats and squid_info_stats.avg_requests_per_minute %}
    <div class="bg-white p-3 sm:p-4 rounded-lg shadow flex items-center transition-all duration-300 ease-in-out hover:shadow-lg">
      <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-teal-100 flex items-center justify-center mr-3 flex-shrink-0">
        <i class="fas fa-chart-line text-teal-500 text-lg sm:text-xl"></i>
      </div>
      <div>
        <p class="text-gray-500 text-xs sm:text-sm">Peticiones/Min</p>
        <p class="text-lg sm:text-xl font-bold">{{ squid_info_stats.avg_requests_per_minute|round(1) }}</p>
      </div>
    </div>
    {% endif %}
  </div>
</div>

{% if valid_users|length > 0 %}
<div class="flex justify-end mb-4">
  <button
    id="toggle-all-button"
    class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 text-sm sm:text-base"
  >
    Ver Resumen
  </button>
</div>
{% endif %}

<div id="user-accordion-group" class="space-y-3">
  {% for user, user_data in valid_users.items() %} 
  {% set connections = user_data.connections %} 
  {% set client_ip = user_data.client_ip %}

  <div class="user-accordion bg-white rounded-lg shadow-md overflow-hidden">
    <div class="w-full text-left p-3 sm:p-4 border-b bg-white">
      <div class="flex flex-col space-y-3 sm:space-y-0">
        <!-- Header principal -->
        <div class="flex items-center justify-between">
          <div class="flex items-center min-w-0 flex-1">
            <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-blue-100 flex items-center justify-center mr-2 sm:mr-3 flex-shrink-0">
              <i class="fas fa-user text-blue-600 text-sm sm:text-base"></i>
            </div>
            <div class="min-w-0 flex-1">
              <h2 class="text-base sm:text-lg font-bold text-gray-800 truncate" title="{{ user }}">{{ user }}</h2>
              <div class="flex items-center text-xs text-gray-500 mt-1">
                <i class="fas fa-network-wired mr-1 text-gray-400"></i>
                <span class="truncate">{{ client_ip }}</span>
              </div>
            </div>
          </div>
          <div class="w-6 text-center flex-shrink-0">
            <i class="fas fa-chevron-down transition-transform duration-300 rotate-180 text-sm sm:text-base"></i>
          </div>
        </div>

        <!-- Stats en grid responsive -->
        <div class="grid grid-cols-2 gap-2 sm:flex sm:flex-wrap sm:items-center sm:gap-x-4 sm:gap-y-2 text-xs sm:text-sm">
          <div class="flex items-center text-gray-600" title="Conexiones totales">
            <i class="fas fa-link mr-1.5 text-blue-500 text-xs"></i>
            <span>{{ connections|length }} conex</span>
          </div>

          {% set user_bw = namespace(value=0) %}
          {% for connection in connections %}
            {% if connection.bandwidth_kbps is defined %}
              {% set user_bw.value = user_bw.value + (connection.bandwidth_kbps|float) %}
            {% endif %}
          {% endfor %}
          <div class="flex items-center text-gray-600" title="Velocidad total">
            <i class="fas fa-tachometer-alt mr-1.5 text-teal-500 text-xs"></i>
            <span class="truncate">{{ format_bandwidth(user_bw.value) }}</span>
          </div>

          {% set total_data = namespace(value=0) %} 
          {% set total_requests = namespace(value=0) %} 
          {% for connection in connections %} 
            {% if connection.fd_total != "N/A" %} 
              {% set total_data.value = total_data.value + connection.fd_total %} 
            {% endif %} 
            {% set total_requests.value = total_requests.value + connection.nrequests %} 
          {% endfor %}

          <div class="flex items-center text-gray-600" title="Datos transferidos">
            <i class="fas fa-database mr-1.5 text-green-500 text-xs"></i>
            <span>{{ (total_data.value / 1024 / 1024)|round(2) }} MB</span>
          </div>

          <div class="flex items-center text-gray-600" title="Total solicitudes">
            <i class="fas fa-bullhorn mr-1.5 text-purple-500 text-xs"></i>
            <span>{{ total_requests.value }} req</span>
          </div>
        </div>
      </div>
    </div>

    <div data-accordion-content>
      <div class="overflow-x-auto -mx-3 sm:mx-0">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Duración</th>
              <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Método</th>
              <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">URL</th>
              <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Datos</th>
              <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden lg:table-cell">Velocidad</th>
              <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden xl:table-cell">Delay Pool</th>
              <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Solicitudes</th>
              <th class="px-2 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase hidden lg:table-cell">Dir. Remota</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for connection in connections %}
            <tr class="transition-colors duration-200 ease-in-out hover:bg-gray-50">
              <td class="px-2 sm:px-4 py-2 whitespace-nowrap text-xs text-gray-500">
                {% set seconds = connection.elapsed_time|float %} 
                {% if seconds >= 3600 %}{{ "%.2f"|format(seconds/3600) }}h
                {% elif seconds >= 60 %}{{ "%.2f"|format(seconds/60) }}min
                {% else %}{{ "%.2f"|format(seconds) }}s{% endif %}
              </td>
              <td class="px-2 sm:px-4 py-2 whitespace-nowrap">
                {% set method = connection.logType|lower %}
                <span class="px-2 py-1 rounded-full text-xs font-semibold {% if method == 'connect' or method == 'tcp_tunnel' %}bg-green-100 text-green-800{% endif %}">
                  {{ connection.logType }}
                </span>
              </td>
              <td class="px-2 sm:px-4 py-2 hidden sm:table-cell">
                <div class="truncate max-w-[150px] lg:max-w-[200px] text-xs transition-colors duration-200 hover:text-blue-600" title="{{ connection.uri }}">
                  {{ connection.uri }}
                </div>
              </td>
              <td class="px-2 sm:px-4 py-2 whitespace-nowrap text-xs">
                {% if connection.fd_total != "N/A" %}{{ (connection.fd_total / 1024 / 1024)|round(2) }} MB
                {% else %}N/A{% endif %}
              </td>
              <td class="px-2 sm:px-4 py-2 whitespace-nowrap text-xs hidden lg:table-cell">
                {{ format_bandwidth(connection.bandwidth_kbps) }}
              </td>
              <td class="px-2 sm:px-4 py-2 whitespace-nowrap hidden xl:table-cell">
                {% if connection.delay_pool != "N/A" %} 
                {% set pool = connection.delay_pool|string %}
                <span class="px-2 py-1 rounded-full text-xs font-semibold {% if pool == '0' %}bg-sky-100 text-sky-800{% endif %}">
                  Pool {{ connection.delay_pool }}
                </span>
                {% else %}<span class="text-xs text-gray-500">N/A</span>{% endif %}
              </td>
              <td class="px-2 sm:px-4 py-2 whitespace-nowrap text-xs font-medium hidden md:table-cell">
                {{ connection.nrequests }}
              </td>
              <td class="px-2 sm:px-4 py-2 whitespace-nowrap text-xs font-mono hidden lg:table-cell hover:text-blue-600">
                {{ connection.proxy_local_ip }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
