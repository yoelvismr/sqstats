<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Navegación</title>
    <script src="{{ url_for('static', filename='js/tailwindcss.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chartjs-plugin-datalabels.js') }}"></script>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">
          Dashboard de Navegación
        </h1>
        <div class="flex flex-wrap justify-between mt-4">
          <div
            class="bg-white p-4 rounded-lg shadow-md w-full md:w-auto mb-4 md:mb-0"
          >
            <h3 class="text-lg font-semibold text-gray-700">
              Usuarios Totales
            </h3>
            <p class="text-2xl font-bold text-blue-600">
              {{ metrics.total_stats.total_users }}
            </p>
          </div>
          <div
            class="bg-white p-4 rounded-lg shadow-md w-full md:w-auto mb-4 md:mb-0"
          >
            <h3 class="text-lg font-semibold text-gray-700">
              Registros de Log
            </h3>
            <p class="text-2xl font-bold text-green-600">
              {{ metrics.total_stats.total_log_entries }}
            </p>
          </div>
          <div
            class="bg-white p-4 rounded-lg shadow-md w-full md:w-auto mb-4 md:mb-0"
          >
            <h3 class="text-lg font-semibold text-gray-700">
              Datos Transmitidos
            </h3>
            <p class="text-2xl font-bold text-purple-600">
              {{ "%.2f"|format(metrics.total_stats.total_data_transmitted /
              (1024**3)) }} GB
            </p>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-md w-full md:w-auto">
            <h3 class="text-lg font-semibold text-gray-700">Total Requests</h3>
            <p class="text-2xl font-bold text-orange-600">
              {{ metrics.total_stats.total_requests }}
            </p>
          </div>
          <div class="w-full md:w-auto flex items-center md:ml-4 mt-4 md:mt-0">
            <div
              class="bg-white p-4 rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow duration-200"
            >
              <h3 class="text-lg font-semibold text-gray-700">
                Filtrar por Fecha
              </h3>
              <div class="reports-date-picker flex items-center gap-2">
                <div
                  class="flex items-center justify-center w-8 h-8 bg-indigo-50 rounded-md"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 text-indigo-600"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M8 7V3m8 4V3M3 11h18M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z"
                    />
                  </svg>
                </div>

                <input
                  id="reports-date"
                  type="text"
                  datepicker
                  datepicker-orientation="bottom"
                  datepicker-autohide
                  datepicker-container="body"
                  class="flex-1 min-w-0 w-32 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder-gray-500 focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 transition-colors duration-200"
                />

                <button
                  id="reports-go"
                  class="inline-flex items-center justify-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 mr-1"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    />
                  </svg>
                  Ver
                </button>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h2 class="text-xl font-bold mb-4 text-gray-800">
            Top 20 Usuarios por Actividad
          </h2>
          <div class="h-80">
            <canvas id="usersActivityChart"></canvas>
          </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
          <h2 class="text-xl font-bold mb-4 text-gray-800">
            Top 20 Usuarios por Datos Transmitidos
          </h2>
          <div class="h-80">
            <canvas id="usersDataChart"></canvas>
          </div>
        </div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-bold mb-4 text-gray-800">
          Distribución de Códigos HTTP
        </h2>
        <div class="h-96">
          <canvas id="httpCodesChart"></canvas>
        </div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-bold mb-4 text-gray-800">
          Top 20 Páginas Más Visitadas
        </h2>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  URL
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Total Requests
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Visitas Únicas
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Datos Transmitidos
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for page in metrics.top_pages %}
              <tr class="hover:bg-gray-50">
                <td
                  class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate max-w-xs"
                >
                  {{ page.url }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ page.total_requests }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ page.unique_visits }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ "%.2f"|format(page.total_data_bytes / (1024**2)) }} MB
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold mb-4 text-gray-800">
          IPs Compartidas por Múltiples Usuarios
        </h2>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  IP
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Número de Usuarios
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Usuarios
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for ip in metrics.users_per_ip %}
              <tr class="hover:bg-gray-50">
                <td
                  class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                >
                  {{ ip.ip }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ ip.user_count }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {{ ip.usernames }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <script type="application/json" id="chart-data">
      {
        "usersActivity": {
          "labels": {{ metrics.top_users_by_activity | map(attribute='username') | list | tojson | safe }},
          "data": {{ metrics.top_users_by_activity | map(attribute='total_visits') | list | tojson | safe }}
        },
        "usersData": {
          "labels": {{ metrics.top_users_by_data_transferred | map(attribute='username') | list | tojson | safe }},
          "data": {{ metrics.top_users_by_data_transferred | map(attribute='total_data_bytes') | map('divide', 1048576) | list | tojson | safe }}
        },
        "httpCodes": {
          "labels": {{ metrics.http_response_distribution_chart.labels | tojson | safe }},
          "data": {{ metrics.http_response_distribution_chart.data | tojson | safe }},
          "colors": {{ metrics.http_response_distribution_chart.colors | tojson | safe }}
        }
      }
    </script>

    <script>
      // Chart.js configuration
      document.addEventListener("DOMContentLoaded", function () {
        // Load data from JSON script tag
        const chartDataElement = document.getElementById("chart-data");
        const chartData = JSON.parse(chartDataElement.textContent);

        const chartColors = [
          "#3B82F6",
          "#10B981",
          "#F59E0B",
          "#EF4444",
          "#8B5CF6",
          "#EC4899",
          "#14B8A6",
          "#F97316",
          "#64748B",
          "#84CC16",
          "#06B6D4",
          "#D946EF",
          "#F43F5E",
          "#0EA5E9",
          "#22C55E",
          "#EAB308",
          "#F43F5E",
          "#8B5CF6",
          "#EC4899",
          "#14B8A6",
        ];

        // Helper function to get text color based on theme
        function getTextColor() {
          return document.documentElement.classList.contains("dark")
            ? "#d1d5db"
            : "#374151";
        }

        // Helper function to get border color based on theme
        function getBorderColor() {
          return document.documentElement.classList.contains("dark")
            ? "#374151"
            : "#fff";
        }

        // Users Activity Chart
        const usersActivityCtx = document.getElementById("usersActivityChart");
        if (usersActivityCtx && chartData.usersActivity) {
          new Chart(usersActivityCtx.getContext("2d"), {
            type: "bar",
            data: {
              labels: chartData.usersActivity.labels,
              datasets: [
                {
                  label: "Visitas",
                  data: chartData.usersActivity.data,
                  backgroundColor: chartColors.slice(
                    0,
                    chartData.usersActivity.data.length
                  ),
                  borderColor: chartColors
                    .slice(0, chartData.usersActivity.data.length)
                    .map((color) => color + "DD"),
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: { mode: "index", intersect: false },
                datalabels: { display: false },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Número de Visitas" },
                  ticks: { color: getTextColor() },
                },
                x: {
                  ticks: {
                    autoSkip: false,
                    color: getTextColor(),
                  },
                },
              },
            },
          });
        }

        // Users Data Chart
        const usersDataCtx = document.getElementById("usersDataChart");
        if (usersDataCtx && chartData.usersData) {
          new Chart(usersDataCtx.getContext("2d"), {
            type: "bar",
            data: {
              labels: chartData.usersData.labels,
              datasets: [
                {
                  label: "Datos (MB)",
                  data: chartData.usersData.data,
                  backgroundColor: chartColors.slice(
                    0,
                    chartData.usersData.data.length
                  ),
                  borderColor: chartColors
                    .slice(0, chartData.usersData.data.length)
                    .map((color) => color + "DD"),
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  mode: "index",
                  intersect: false,
                  callbacks: {
                    label: function (context) {
                      return (
                        context.dataset.label +
                        ": " +
                        context.raw.toFixed(2) +
                        " MB"
                      );
                    },
                  },
                },
                datalabels: { display: false },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Datos Transmitidos (MB)" },
                  ticks: { color: getTextColor() },
                },
                x: {
                  ticks: {
                    autoSkip: false,
                    color: getTextColor(),
                  },
                },
              },
            },
          });
        }

        // HTTP Codes Chart
        const httpCodesCtx = document.getElementById("httpCodesChart");
        if (httpCodesCtx && chartData.httpCodes) {
          new Chart(httpCodesCtx.getContext("2d"), {
            type: "pie",
            data: {
              labels: chartData.httpCodes.labels,
              datasets: [
                {
                  data: chartData.httpCodes.data,
                  backgroundColor: chartData.httpCodes.colors,
                  borderColor: getBorderColor(),
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "right",
                  labels: {
                    font: { size: 12 },
                    color: getTextColor(),
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const total = context.dataset.data.reduce(function (
                        a,
                        b
                      ) {
                        return a + b;
                      },
                      0);
                      const percentage = ((context.raw / total) * 100).toFixed(
                        1
                      );
                      return (
                        context.label +
                        ": " +
                        context.raw +
                        " (" +
                        percentage +
                        "%)"
                      );
                    },
                  },
                },
                datalabels: {
                  formatter: function (value, ctx) {
                    const total = ctx.chart.data.datasets[0].data.reduce(
                      function (a, b) {
                        return a + b;
                      },
                      0
                    );
                    const percentage = ((value / total) * 100).toFixed(1);
                    return percentage > 3 ? percentage + "%" : "";
                  },
                  color: "#fff",
                  font: {
                    weight: "bold",
                    size: 12,
                  },
                },
              },
            },
            plugins: [ChartDataLabels],
          });
        }

        // Update chart colors when dark mode changes
        const observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            if (
              mutation.type === "attributes" &&
              mutation.attributeName === "class"
            ) {
              // Re-render charts with new colors when dark mode changes
              setTimeout(function () {
                Chart.helpers.each(Chart.instances, function (instance) {
                  // Update scale colors
                  if (
                    instance.config.options &&
                    instance.config.options.scales
                  ) {
                    const textColor = getTextColor();
                    if (
                      instance.config.options.scales.y &&
                      instance.config.options.scales.y.ticks
                    ) {
                      instance.config.options.scales.y.ticks.color = textColor;
                    }
                    if (
                      instance.config.options.scales.x &&
                      instance.config.options.scales.x.ticks
                    ) {
                      instance.config.options.scales.x.ticks.color = textColor;
                    }
                  }
                  // Update legend colors
                  if (
                    instance.config.options &&
                    instance.config.options.plugins &&
                    instance.config.options.plugins.legend &&
                    instance.config.options.plugins.legend.labels
                  ) {
                    instance.config.options.plugins.legend.labels.color =
                      getTextColor();
                  }
                  instance.update();
                });
              }, 100);
            }
          });
        });

        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ["class"],
        });
      });
    </script>
  <script src="{{ url_for('static', filename='js/reports-datepicker.js') }}"></script>
  </body>
</html>
